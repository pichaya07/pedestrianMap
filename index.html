<html>
	<head>
		<meta charset="utf-8">
		<!-- Leaflet library-->
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
		<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

		<!-- map -->

		<link rel="stylesheet" href="custom.css" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

		<script src="skobbler-2.0.js"></script>

		<!-- leaflet -->

		<!-- JQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

		<title>Pedestrian map for Blind</title>
	</head>
	<body>
		
		<div id="map">
			
		</div>

		<div class="over_map">
			<input type="button" id="get_direction" class="bnt" value="Get direction" name="1" onclick="getDirection(this.name)" />
			
		</div>

		<div class="over_map input" id="inputOD">
				<input id="origin" class="search origin" type="text" placeholder="from" onchange="setStartPoint(this.value)"></input>
				<input id="dest" class="search dest" type="text" placeholder="to" onchange="setDestPoint(this.value)"></input>
				<input type="button" class="bnt inline" value="GO !!" onclick="convertPlaceNameToCoor()" />
		</div>

		<div id="searchBox">
			<input type="text" placeholder="search place" onchange="searchPlace(this.value)"></input>
			<div id="search_result">
		</div>
		</div>
		
	</body>
</html>

<script src="map.js"></script>

<script>

var origin,dest,org_lat,org_lon,dest_lat,dest_lon;


//search

function searchPlace(place){

	var search_url = 'http://nominatim.openstreetmap.org/search.php?format=json&q='+place+'&polygon=1&viewbox=';
	console.log(search_url);


	$.ajax({
		url: search_url, 
		dataType : 'json',
		beforeSend : function(){
			var div_searchBox = document.getElementById('searchBox');
			div_searchBox.innerHTML = div_searchBox.innerHTML + '<img id="loader" src="image/loader.gif">';
		},
		success: function(res){
			document.getElementById('search_result').style.visibility = "visible";

        	console.log(res);
        	
        	var div_result = document.getElementById('search_result');
        	var lat,lon,placeName;

        	//clear previous search
        	div_result.innerHTML = '';

        	if(res.length == 0)//if no result
        		div_result.innerHTML = '<div class="search_res noResult">Sorry, no result</div>';
        	else{
        		//show result
	        	for(var i = 0; i<res.length; i++){
	        		lat = res[i].lat;
	        		lon = res[i].lon;
	        		placeName = res[i].display_name;
	        		div_result.innerHTML = div_result.innerHTML + '<div class="search_res" onclick="moveTo('+lat+","+lon+')">'+placeName+'</div>';
	        	}
        	}
        	
	    },
	    complete: function() {
	    	document.getElementById("loader").remove();
	    }
	});
}

function moveTo(lat,lon){
	var circle;
	map.panTo(L.latLng(lat, lon));

	circle_layer.clearLayers();

	circle = new L.circle([lat, lon], 300, {
	    color: 'red',
	    fillColor: '#f03',
	    fillOpacity: 0.5
	}).addTo(circle_layer);

	circle.bindPopup("[lat,lon] : ["+lat+","+lon+"]");

}

function getDirection(value){
	console.log(value);
	if(value==1){
		document.getElementById('inputOD').style.visibility = "visible";
		document.getElementById('get_direction').name= "0";
		document.getElementById('get_direction').value= "collapse";
		
	}
	else{
		document.getElementById('inputOD').style.visibility = "hidden";
		document.getElementById('get_direction').name = "1";
		document.getElementById('get_direction').value= "Get direction";
	}
		
}
function setStartPoint(str){
	origin = str;
	console.log(origin);
}

function setDestPoint(end){
	dest = end;
	console.log(dest);

}

function convertPlaceNameToCoor(){
	origin = document.getElementById('origin').value;
	dest = document.getElementById('dest').value;

	//sample request == http://nominatim.openstreetmap.org/?format=json&addressdetails=1&q=berlin&format=json&limit=1
	var res_orgin_req = 'http://nominatim.openstreetmap.org/?format=json&addressdetails=1&q='+origin+'&format=json&limit=1';

	var res_dest_req = 'http://nominatim.openstreetmap.org/?format=json&addressdetails=1&q='+dest+'&format=json&limit=1';

	$.ajax({
		url: res_orgin_req, 
		dataType : 'json',
		success: function(res){
			console.log(res);
			org_lat = res[0].lat;
			org_lon = res[0].lon;	

			$.ajax({
				url: res_dest_req, 
				dataType : 'json',
				success: function(result){
					console.log(result);
					dest_lat = result[0].lat;
					dest_lon = result[0].lon;	
					calRoute();
			    }
			});
	    }
	});

	

}

function calRoute(){ //calRoute : use Skobbler service 

	
	route_layer.clearLayers(); //clear previous route

	var requestRoute = 'http://'+API_KEY+'.tor.skobbler.net/tor/RSngx/calcroute/json/20_5/en/'+API_KEY+'?start='+org_lat+','+org_lon+'&dest='+dest_lat+','+dest_lon+'&profile=pedestrian&advice=yes&points=yes';

	console.log(requestRoute);

	$.ajax({
		url: requestRoute, 
		dataType : 'json',
		beforeSend : function(){
			
		},
		success: function(res){
			console.log(res.route);
			var pos_array = res.route;

			var lat,lon,dist,inst,marker; //inst == instruction
			console.log(res.status.apiMessage);

			var routePoint = res.route.routePoints;
			//draw route;

			var latlng_arr = [], latlng;
			for(var i = 0; i < routePoint.length ; i++){
					lat = routePoint[i].y;
					lon = routePoint[i].x;

					latlng = new L.LatLng(lat, lon);
					latlng_arr.push(latlng);
					
			}

			var polyline = new L.Polyline(latlng_arr, {
				color: 'red',
				weight: 6,
				smoothFactor: 1,
				opacity: .7,
                dashArray: '20,15',
                lineJoin: 'round'

			});

			polyline.addTo(route_layer);

			
			
			for(var i = 0; i < pos_array.advisor.length ; i++){
					lat = pos_array.advisor[i].coordinates.y;
					lon = pos_array.advisor[i].coordinates.x;
					dist = pos_array.advisor[i].distance;
					inst = pos_array.advisor[i].instruction;
					console.log(lat+" , "+lon+" dist: "+dist+" dest: "+inst);
					map.panTo(L.latLng(lat, lon));
					marker = L.marker([lat, lon]).addTo(route_layer);
					marker.bindPopup(i+") "+inst);
			}
	    },
	    complete: function() {
	    	
	    }
	});


}

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
	
</script>
